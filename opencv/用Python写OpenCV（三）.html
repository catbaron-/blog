<!DOCTYPE html><html>

<head>
<meta charset="utf-8">
<title>用Python写OpenCV（三）</title>
<style type="text/css">
body {
  font-family: Helvetica, arial, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  padding-top: 10px;
  padding-bottom: 10px;
  background-color: white;
  padding: 30px; }

body > *:first-child {
  margin-top: 0 !important; }
body > *:last-child {
  margin-bottom: 0 !important; }

a {
  color: #4183C4; }
a.absent {
  color: #cc0000; }
a.anchor {
  display: block;
  padding-left: 30px;
  margin-left: -30px;
  cursor: pointer;
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0; }

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
  cursor: text;
  position: relative; }

h1:hover a.anchor, h2:hover a.anchor, h3:hover a.anchor, h4:hover a.anchor, h5:hover a.anchor, h6:hover a.anchor {
  background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA09pVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoMTMuMCAyMDEyMDMwNS5tLjQxNSAyMDEyLzAzLzA1OjIxOjAwOjAwKSAgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OUM2NjlDQjI4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OUM2NjlDQjM4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo5QzY2OUNCMDg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo5QzY2OUNCMTg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PsQhXeAAAABfSURBVHjaYvz//z8DJYCRUgMYQAbAMBQIAvEqkBQWXI6sHqwHiwG70TTBxGaiWwjCTGgOUgJiF1J8wMRAIUA34B4Q76HUBelAfJYSA0CuMIEaRP8wGIkGMA54bgQIMACAmkXJi0hKJQAAAABJRU5ErkJggg==) no-repeat 10px center;
  text-decoration: none; }

h1 tt, h1 code {
  font-size: inherit; }

h2 tt, h2 code {
  font-size: inherit; }

h3 tt, h3 code {
  font-size: inherit; }

h4 tt, h4 code {
  font-size: inherit; }

h5 tt, h5 code {
  font-size: inherit; }

h6 tt, h6 code {
  font-size: inherit; }

h1 {
  font-size: 28px;
  color: black; }

h2 {
  font-size: 24px;
  border-bottom: 1px solid #cccccc;
  color: black; }

h3 {
  font-size: 18px; }

h4 {
  font-size: 16px; }

h5 {
  font-size: 14px; }

h6 {
  color: #777777;
  font-size: 14px; }

p, blockquote, ul, ol, dl, li, table, pre {
  margin: 15px 0; }

hr {
  background: transparent url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC) repeat-x 0 0;
  border: 0 none;
  color: #cccccc;
  height: 4px;
  padding: 0;
}

body > h2:first-child {
  margin-top: 0;
  padding-top: 0; }
body > h1:first-child {
  margin-top: 0;
  padding-top: 0; }
  body > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0; }
body > h3:first-child, body > h4:first-child, body > h5:first-child, body > h6:first-child {
  margin-top: 0;
  padding-top: 0; }

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0; }

h1 p, h2 p, h3 p, h4 p, h5 p, h6 p {
  margin-top: 0; }

li p.first {
  display: inline-block; }
li {
  margin: 0; }
ul, ol {
  padding-left: 30px; }

ul :first-child, ol :first-child {
  margin-top: 0; }

dl {
  padding: 0; }
  dl dt {
    font-size: 14px;
    font-weight: bold;
    font-style: italic;
    padding: 0;
    margin: 15px 0 5px; }
    dl dt:first-child {
      padding: 0; }
    dl dt > :first-child {
      margin-top: 0; }
    dl dt > :last-child {
      margin-bottom: 0; }
  dl dd {
    margin: 0 0 15px;
    padding: 0 15px; }
    dl dd > :first-child {
      margin-top: 0; }
    dl dd > :last-child {
      margin-bottom: 0; }

blockquote {
  border-left: 4px solid #dddddd;
  padding: 0 15px;
  color: #777777; }
  blockquote > :first-child {
    margin-top: 0; }
  blockquote > :last-child {
    margin-bottom: 0; }

table {
  padding: 0;border-collapse: collapse; }
  table tr {
    border-top: 1px solid #cccccc;
    background-color: white;
    margin: 0;
    padding: 0; }
    table tr:nth-child(2n) {
      background-color: #f8f8f8; }
    table tr th {
      font-weight: bold;
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr td {
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr th :first-child, table tr td :first-child {
      margin-top: 0; }
    table tr th :last-child, table tr td :last-child {
      margin-bottom: 0; }

img {
  max-width: 100%; }

span.frame {
  display: block;
  overflow: hidden; }
  span.frame > span {
    border: 1px solid #dddddd;
    display: block;
    float: left;
    overflow: hidden;
    margin: 13px 0 0;
    padding: 7px;
    width: auto; }
  span.frame span img {
    display: block;
    float: left; }
  span.frame span span {
    clear: both;
    color: #333333;
    display: block;
    padding: 5px 0 0; }
span.align-center {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-center > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: center; }
  span.align-center span img {
    margin: 0 auto;
    text-align: center; }
span.align-right {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-right > span {
    display: block;
    overflow: hidden;
    margin: 13px 0 0;
    text-align: right; }
  span.align-right span img {
    margin: 0;
    text-align: right; }
span.float-left {
  display: block;
  margin-right: 13px;
  overflow: hidden;
  float: left; }
  span.float-left span {
    margin: 13px 0 0; }
span.float-right {
  display: block;
  margin-left: 13px;
  overflow: hidden;
  float: right; }
  span.float-right > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: right; }

code, tt {
  margin: 0 2px;
  padding: 0 5px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px; }

pre code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent; }

.highlight pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }

pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }
  pre code, pre tt {
    background-color: transparent;
    border: none; }

sup {
    font-size: 0.83em;
    vertical-align: super;
    line-height: 0;
}
* {
	-webkit-print-color-adjust: exact;
}
@media screen and (min-width: 914px) {
    body {
        width: 854px;
        margin:0 auto;
    }
}
@media print {
	table, pre {
		page-break-inside: avoid;
	}
	pre {
		word-wrap: break-word;
	}
}
</style>
<style type="text/css">
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', monospace;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #a67f59;
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important {
	font-weight: bold;
}

.token.entity {
	cursor: help;
}
</style>
</head>
<body>
<h3>2.2 关于项目</h3>

<p>通过cookbook来学习OpenCV是比较常见的途径。里面涉及了很多算法，但是往往很少有关于高阶应用的开发。某种程度上，由于OpenCV的应用十分多样，所以这种途径是比较易懂。比如我们可以把OpenCV应用在图形编辑，动作控制游戏，机器人的人工智能，或者是记录受验者眼睛动作的心理实验等方面。但通过种种不同的应用，我们真的能掌握一套抽象工具么？</p>

<p>我相信，我们越早开始创建抽象项目越好。我们会通过一个应用来使学习结构化，不过，在每一个阶段，我们会设计这个应用的各个组件，使其能够被扩展和复用。</p>

<p>我们会开发一个交互应用，用来做面部追踪和实时的摄像头图像操作。这种应用覆盖了OpenCV一大波功能，而且我们必须挑战自己去实现一个有用，高效的方法。否则用户立刻就会发现应用的瑕疵，比如帧率太低，或者追踪不准确。为了得到最好的结果，我们会尝试传统的图像处理方法和深度图像处理两种方法。</p>

<p>我们的应用还会做实时的脸部融合。输入两个摄像头的视频流（或者，也可以是提前录好的视频），应用会把一个视频里的脸叠加到另一个上面。我们会给这个混合场景用一些过滤和变形，让它显得更加和谐。用户会有一种进入其他场景，或者变成另一个人的临场感。这种体验在类似于迪士尼公园的主题公园中比较常见。我们给这个应用起名叫Cameo。cameo指的是宝石中对人的倒影，或者是电影中由名演员演的龙套角色。</p>

<h3>2.3 面向对象设计</h3>

<p>Python应用可以写成单纯的过程式。这种方式经常用在小的应用上，比如我们前面讨论的基本I/O脚本。不过从现在开始我们要用面向对象的方式了，因为这样更加模块化，更容易扩展。</p>

<p>从我们前面对OpenCV的I/O功能的了解来看，我们知道所有的图片都差不多，不论它们的来源和结果如何。不管我们从哪里拿到流数据或者是图片，不管我们要把它们输出到什么地方，我们总能用相同的应用处理逻辑来处理每一帧。在类似Cameo的应用里面，我们要用到多I/O流，这里把应用代码和I/O代码分离会十分方便。</p>

<p>我们会创建这么几个类，分别叫做CaptureManager和WindowManage来作为I/O流的高级接口。我们的应用代码会使用CaptureManager来阅读新的帧，然后可以把每一帧都送到一个或多个输出端，包括静态的图片文件，视频文件，或者一个窗口（通过WindowManager类）。WindowManager类让我们的应用代码能用面向对象的方式处理窗口和事件。</p>

<p>CaptureManager和WindowManager类都是可扩展的。我们并不一定要依赖于OpenCV来处理I/O，在附录A中，讨论了配合Pygame使用WindowManager的子类。</p>

<h4>2.3.1 抽象出视频流——managers.CaputreManager</h4>

<p>正如我们之前所见，OpenCV可以捕捉、播放，而且可以录制从视频文件或者摄像头获得的图像流。但是在不同的场景下，会有不同的考虑。我们的CaptureManager类会抽象出其中的不同点，并提供了一个更高级别的接口，用来从捕捉到的流中分发图像到一个或多个输出——一个静态图像文件，一个视频文件，或者是一个窗口——中去。</p>

<p>一个CaptureManager类可以用VideoCapture类初始化，然后就拥有了enterFrame()和exitFrame()方法。这两个方法应该在每次执行主循环的时候都被调用。在调用enterFrame()和exitFrame()两个方法之间，应用可能会（多次）设置一个通道属性，得到一帧的属性。通道属性的初始值是0，而且只有多孔摄像头会用到其他值。帧属性是在enterFrame()被调用的时候，与图片相关的通道状态。实际的写操作会被推迟到exitFrame()被执行。在exitFrame()方法中，帧属性会被显示到窗口。取决于应用是否提供WindowManager类，帧属性可能会作为参数提供给CaptureManager的构造函数，也可能用previewWindowManager属性设置。</p>

<p>如果应用对帧进行操作，这些操作会反映在录制的文件中和窗口中。CaptureManager类的构造函数有一个参数和一个属性叫做shouldMirrorPreview，当我们想要在窗口中而不是在文件中给帧做个镜像（水平翻转）的时候，这个属性应该设为True。一般来说，当面对摄像头的时候，用户更倾向于面对镜像。</p>

<p>再说一次，VideoWriter类需要一个帧率，但是OpenCV并不提供从摄像头获得准确帧率的方法。CaptureManager类使用一个帧计数器来绕过这个限制，需要Python的标准函数time.time()来估算帧率。但这个方法并不是那么可靠。在不同的帧率波动下，以及不同的系统对time.time()的实现不同，对帧率的估算结果在某些情况下会不太喜人。然而如果我们是在一个未知的硬件上做开发，这总要好过假设用户的摄像头有一个特定的帧率。</p>

<p>我们来创建一个文件叫做mamagers.py，里面会包含我们的CaptureManager的实现。这个实现会很长，所以我们来分成几块来看。首先，我们增加引入，一个构造器和一些属性进去，如下：</p>

<pre><code>   import cv2
   import numpy
   import time
   class CaptureManager(object):
       def __init__(self, capture, previewWindowManager = None,
                    shouldMirrorPreview = False):
           self.previewWindowManager = previewWindowManager
           self.shouldMirrorPreview = shouldMirrorPreview
           self._capture = capture
           self._channel = 0
           self._enteredFrame = False
           self._frame = None
           self._imageFilename = None
           self._videoFilename = None
           self._videoEncoding = None
           self._videoWriter = None
           self._startTime = None
           self._framesElapsed = long(0)
           self._fpsEstimate = None
       @property
       def channel(self):
           return self._channel
       @channel.setter
       def channel(self, value):
           if self._channel != value:
               self._channel = value
               self._frame = None
       @property
       def frame(self):
           if self._enteredFrame and self._frame is None:
               _, self._frame = self._capture.retrieve(\
                   channel = self.channel)
           return self._frame
       @property
       def isWritingImage(self):
           return self._imageFilename is not None
       @property
       def isWritingVideo(self):
           return self._videoFilename is not None
</code></pre>

<p>注意到我们大部分的变量都是非公开的，在变量前都有一个下划线，比如self._enteredFrame。这些变量和当前帧的状态，以及任意一个文件写操作有关。正如之前讨论过的，应用只需要通过传递构造器的参数，或者设置公共变量，来做一些设置，比如摄像头通道，窗口管理器，或者是镜像预览的选项。</p>

<p>在Python中，以一个下划线开头的变量会被当做保护变量处理（只能在本类或子类的内部被调用），以两个下划线开头的变量则是私有变量（只能在本类内部被访问）。</p>

<p>继续我们的实现，我们来加入enterFrame()和exitFrame()方法：</p>

<pre><code>       def enterFrame(self):
           &quot;&quot;&quot;Capture the next frame, if any.&quot;&quot;&quot;
           # But first, check that any previous frame was exited.
           assert not self._enteredFrame, \
               &#39;previous enterFrame() had no matching exitFrame()&#39;
           if self._capture is not None:
               self._enteredFrame = self._capture.grab()
￼￼￼￼       def exitFrame (self):
           &quot;&quot;&quot;Draw to the window. Write to files. Release the frame.&quot;&quot;&quot;
           # Check whether any grabbed frame is retrievable.
           # The getter may retrieve and cache the frame.
           if self.frame is None:
               self._enteredFrame = False
               return
           # Update the FPS estimate and related variables.
           if self._framesElapsed == 0:
               self._startTime = time.time()
           else:
               timeElapsed = time.time() - self._startTime
               self._fpsEstimate =  self._framesElapsed / timeElapsed
           self._framesElapsed += 1
           # Draw to the window, if any.
           if self.previewWindowManager is not None:
               if self.shouldMirrorPreview:
                   mirroredFrame = numpy.fliplr(self._frame).copy()
                   self.previewWindowManager.show(mirroredFrame)
               else:
                   self.previewWindowManager.show(self._frame)
           # Write to the image file, if any.
           if self.isWritingImage:
               cv2.imwrite(self._imageFilename, self._frame)
               self._imageFilename = None
           # Write to the video file, if any.
           self._writeVideoFrame()
           # Release the frame.
           self._frame = None
           self._enteredFrame = False
</code></pre>

<p>要注意，enterFrame()的实现只抓取（同步）一帧，不过真正从通道中抓取数据的行为，会被推迟到后面读取帧变量的时候。exitFrame()的实现中，从当前通道获得图片，计算当前的帧率，然后把图片通过window manager（如果有的话）显示，再来满足后面追加的写入图片文件的请求。</p>

<p>还有一些关于写文件的方法。为了完成我们的类的实现，我们要增加一些写文件方法进来：</p>

<pre><code>       def writeImage(self, filename):
           &quot;&quot;&quot;Write the next exited frame to an image file.&quot;&quot;&quot;
           self._imageFilename = filename
       def startWritingVideo(
               self, filename,
               encoding = cv2.cv.CV_FOURCC(&#39;I&#39;,&#39;4&#39;,&#39;2&#39;,&#39;0&#39;)):
           &quot;&quot;&quot;Start writing exited frames to a video file.&quot;&quot;&quot;
           self._videoFilename = filename
           self._videoEncoding = encoding
       def stopWritingVideo (self):
           &quot;&quot;&quot;Stop writing exited frames to a video file.&quot;&quot;&quot;
           self._videoFilename = None
           self._videoEncoding = None
           self._videoWriter = None
       def _writeVideoFrame(self):
           if not self.isWritingVideo:
               return
           if self._videoWriter is None:
               fps = self._capture.get(cv2.cv.CV_CAP_PROP_FPS)
               if fps == 0.0:
                   # The capture&#39;s FPS is unknown so use an estimate.
                   if self._framesElapsed &lt; 20:
                       # Wait until more frames elapse so that the
                       # estimate is more stable.
                       return
                   else:
                       fps = self._fpsEstimate
               size = (int(self._capture.get(
                           cv2.cv.CV_CAP_PROP_FRAME_WIDTH)),
                       int(self._capture.get(
                           cv2.cv.CV_CAP_PROP_FRAME_HEIGHT)))
               self._videoWriter = cv2.VideoWriter(
                   self._videoFilename, self._videoEncoding,

</code></pre>

<p>公用方法writeImage()，startWritingVideo()，和stopWritingVideo()，只是简单的记录了写文件操作的参数，而实际上写操作是在调用exitFrame()方法之后。非公开方法_writeVideoFrame()创建或追加内容到一个视频文件，用的方法与我们之前的脚本相近。（参考 读写视频文件 一节）然而，在不知道帧率的情况下，我们会在图像抓取的开始部分跳过一些帧，这样我们能有时间来估算当前的帧率。</p>

<p>虽然我们当前的CaptureManager依赖于VideoCapture，我们也能不用OpenCV作为输入。比如我们可以写一个套接字的子类，它的字节流可以作为图像流被分析。我们还可以用第三方的摄像头库来写子类，可以比OpenCV更好的支持不同的设备。不过对于Cameo，我们当前的实现已经足够了。</p>

<script type="text/javascript">
self="undefined"!=typeof window?window:"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?self:{};var Prism=function(){var e=/\blang(?:uage)?-(?!\*)(\w+)\b/i,t=self.Prism={util:{encode:function(e){return e instanceof n?new n(e.type,t.util.encode(e.content),e.alias):"Array"===t.util.type(e)?e.map(t.util.encode):e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/\u00a0/g," ")},type:function(e){return Object.prototype.toString.call(e).match(/\[object (\w+)\]/)[1]},clone:function(e){var n=t.util.type(e);switch(n){case"Object":var a={};for(var r in e)e.hasOwnProperty(r)&&(a[r]=t.util.clone(e[r]));return a;case"Array":return e.slice()}return e}},languages:{extend:function(e,n){var a=t.util.clone(t.languages[e]);for(var r in n)a[r]=n[r];return a},insertBefore:function(e,n,a,r){r=r||t.languages;var i=r[e],l={};for(var o in i)if(i.hasOwnProperty(o)){if(o==n)for(var s in a)a.hasOwnProperty(s)&&(l[s]=a[s]);l[o]=i[o]}return r[e]=l},DFS:function(e,n){for(var a in e)n.call(e,a,e[a]),"Object"===t.util.type(e)&&t.languages.DFS(e[a],n)}},highlightAll:function(e,n){for(var a,r=document.querySelectorAll('code[class*="language-"], [class*="language-"] code, code[class*="lang-"], [class*="lang-"] code'),i=0;a=r[i++];)t.highlightElement(a,e===!0,n)},highlightElement:function(a,r,i){for(var l,o,s=a;s&&!e.test(s.className);)s=s.parentNode;if(s&&(l=(s.className.match(e)||[,""])[1],o=t.languages[l]),o){a.className=a.className.replace(e,"").replace(/\s+/g," ")+" language-"+l,s=a.parentNode,/pre/i.test(s.nodeName)&&(s.className=s.className.replace(e,"").replace(/\s+/g," ")+" language-"+l);var c=a.textContent;if(c){var g={element:a,language:l,grammar:o,code:c};if(t.hooks.run("before-highlight",g),r&&self.Worker){var u=new Worker(t.filename);u.onmessage=function(e){g.highlightedCode=n.stringify(JSON.parse(e.data),l),t.hooks.run("before-insert",g),g.element.innerHTML=g.highlightedCode,i&&i.call(g.element),t.hooks.run("after-highlight",g)},u.postMessage(JSON.stringify({language:g.language,code:g.code}))}else g.highlightedCode=t.highlight(g.code,g.grammar,g.language),t.hooks.run("before-insert",g),g.element.innerHTML=g.highlightedCode,i&&i.call(a),t.hooks.run("after-highlight",g)}}},highlight:function(e,a,r){var i=t.tokenize(e,a);return n.stringify(t.util.encode(i),r)},tokenize:function(e,n){var a=t.Token,r=[e],i=n.rest;if(i){for(var l in i)n[l]=i[l];delete n.rest}e:for(var l in n)if(n.hasOwnProperty(l)&&n[l]){var o=n[l];o="Array"===t.util.type(o)?o:[o];for(var s=0;s<o.length;++s){var c=o[s],g=c.inside,u=!!c.lookbehind,f=0,h=c.alias;c=c.pattern||c;for(var p=0;p<r.length;p++){var d=r[p];if(r.length>e.length)break e;if(!(d instanceof a)){c.lastIndex=0;var m=c.exec(d);if(m){u&&(f=m[1].length);var y=m.index-1+f,m=m[0].slice(f),v=m.length,k=y+v,b=d.slice(0,y+1),w=d.slice(k+1),N=[p,1];b&&N.push(b);var O=new a(l,g?t.tokenize(m,g):m,h);N.push(O),w&&N.push(w),Array.prototype.splice.apply(r,N)}}}}}return r},hooks:{all:{},add:function(e,n){var a=t.hooks.all;a[e]=a[e]||[],a[e].push(n)},run:function(e,n){var a=t.hooks.all[e];if(a&&a.length)for(var r,i=0;r=a[i++];)r(n)}}},n=t.Token=function(e,t,n){this.type=e,this.content=t,this.alias=n};if(n.stringify=function(e,a,r){if("string"==typeof e)return e;if("[object Array]"==Object.prototype.toString.call(e))return e.map(function(t){return n.stringify(t,a,e)}).join("");var i={type:e.type,content:n.stringify(e.content,a,r),tag:"span",classes:["token",e.type],attributes:{},language:a,parent:r};if("comment"==i.type&&(i.attributes.spellcheck="true"),e.alias){var l="Array"===t.util.type(e.alias)?e.alias:[e.alias];Array.prototype.push.apply(i.classes,l)}t.hooks.run("wrap",i);var o="";for(var s in i.attributes)o+=s+'="'+(i.attributes[s]||"")+'"';return"<"+i.tag+' class="'+i.classes.join(" ")+'" '+o+">"+i.content+"</"+i.tag+">"},!self.document)return self.addEventListener?(self.addEventListener("message",function(e){var n=JSON.parse(e.data),a=n.language,r=n.code;self.postMessage(JSON.stringify(t.util.encode(t.tokenize(r,t.languages[a])))),self.close()},!1),self.Prism):self.Prism;var a=document.getElementsByTagName("script");return a=a[a.length-1],a&&(t.filename=a.src,document.addEventListener&&!a.hasAttribute("data-manual")&&document.addEventListener("DOMContentLoaded",t.highlightAll)),self.Prism}();"undefined"!=typeof module&&module.exports&&(module.exports=Prism);
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Register.StartupHook('End', function () {
   MathJaxListener.invokeCallbackForKey_('End');
});
</script>
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>

</html>
