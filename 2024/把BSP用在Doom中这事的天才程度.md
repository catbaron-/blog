---
author: catbaron
title: 把BSP用在Doom中这事的天才程度
date: 2024-05-30
draft: true
categories:
  - 作
tags:
  - translate
  - game
---
[原文链接](https://twobithistory.org/2019/11/06/doom-bsp.html)

1993 年，id Software 发布了 FPS 游戏 *Doom*，此游戏一经发售就立刻成为现象级作品。
在如今，这款游戏也被视为影响最为深远的游戏之一。

在 Doom 发售十年后的 2003 年，记者 David Kushner 出版了一本关于 id Software 的书，
叫做《Doom 启示录》，并从此成为了关于创造 Doom 的重要文献。
我在几年前阅读了《Doom 启示录》，其中的大部分内容已经被我遗忘。
但唯独有一个关于首席程序员 John Carmack 的故事一直萦绕在我心头。
我们会在后面详细回顾这个故事，但简单地说，在 Doom 的开发初期，
Carmack 意识到他编写的 3D 渲染器再渲染一些特定关卡的时候会慢到令人发指。
这是令人无法接受的，因为 Doom 理应是动力十足充满激情的游戏。
所以 Carmack 意识到这是一个触及根基的问题，他需要找到一个更好的渲染算法来解决它。
于是他开始阅读论文，并最终实现了一个叫做 Binary Space Partitioning （BSP）的技术。
这项技术在此之前从来没有被应用在电子游戏中，却极大地提高了 Doom 引擎的运行速度。

这个 Carmack 将最尖端的技术应用在电子游戏上的故事总是能打动我。
对我来说，这正是 Carmack 之所以能成为一个传奇的原因。
他在诸多方面都无愧于天才游戏程序员的称号，
这段关于学术论文和 BSP 技术的历史则在我心中位列榜首。

当然了，这个故事让人印象深刻的原因之一就是，
Binary Space Partitioning 这个技术的名字听起来好像很高深，感觉你很难自己动手实现它。
很长一段时间我都认为这是 Carmack 做出的一个智力飞跃，
但因为我一直以来都没有真正理解 BSP 是什么，
或者在 Carmack 决定使用它的时候这项技术有多先进，
所以我一直都不确定，如果绘制一条从辛普森到爱因斯坦的智力光谱，
Carmack 把 BSP 添加到 Doom 中这件事能排到哪？

而且我也好奇，BSP 的技术最初是从哪来的，它最后又是如何被 Carmack 发现。
所以这篇文章不仅是关于 Carmack 和 Doom，
同时也是关于 Binary Space Partitioning Tree （BSP 树）这一数据结构的历史。
有趣的是，BSP 树和很多其他的计算机技术一样，源自军方的研究活动。

没错：E1M1，也就是 Doom 的第一关，由美国空军为您呈现。

## VSD 问题
BSP 树的设计是为了解决计算机图形学中有一个非常棘手的问题：
为了渲染一个三维空间，给定一个视角，渲染器必须能够区别出什么能被看到而什么不能。
如果你有很多时间的话，这不是什么大问题，但一个实时的游戏引擎需要在一秒内判断至少 30 次。

这个问题有时会被称作**可见表面决策**（Visible Surface Determination）。
Michael Abrash，一个和 Carmack 一起开发 Quake（id Software 在 Doom 之后的作品）的程序员，
曾经在他著名的《图形编程黑皮书》（_Graphics Programming Black Book_）中提到 VSD 问题：

> 我想谈一下我认为最棘手的 3-D 问题：可见表面决策（在每个像素上绘制正确的表面），
> 以及它的近亲问题，多边形剔除（通过尽快剔除不可见的多边形来加速可见表面决策）。
> 为了表述的简洁，我在下文会用 VSD 来同时指代这两者。
>
> 为什么我会认为 VSD 是 3-D 技术中最棘手的挑战？
> 虽然类似纹理映射这种光栅化相关的问题也很有趣且重要，但他们的应用范围相对有限，
> 而且可以被移交给诸如 3-D 加速器之类的硬件来处理；
> 同时，他们的处理难度只和屏幕的分辨率相关，所以相对来说比较容易应对。
> 
> 然而，VSD 确是一个开放性的问题，已经有几十种应用方法。
> 最重要的是，如果不能用恰当的方法应对，VSD的规模会随着场景的复杂度呈平方甚至立方函数增长，
> 所以它很快就会变成渲染真实世界的一个限制因素。

Abrash 所谈及的是在 90 年代末期时想要解决 VSD 问题的难度。
此时 *Doom* 的成功已经证明普通玩家想要在他们的家用电脑上玩到图形密集性游戏（graphically intensive games）。
在 90 年代初期 id Software 该开始发行游戏的时候，
游戏开发必须精打细算，以图能够在那些不是为了游戏而开发的电脑上运行。
本来这些电脑只会用来运行一些文字处理软件或者表格应用之类的小玩意。
为了让游戏能跑得起来——特别是 id Software 在 Doom 之前开发的一些 3D 游戏——id Software 必须非常有创造力。
在这些游戏中，他们的关卡设计需要保证 VSD 问题易于解决。

举例来说，在*重返德军总部 3D* 这款 id Software 在 Doom 之前发售的游戏中，
每个关卡的墙壁都是轴对齐（axis-aligned）的。
换句话说，在*重返德军总部*的世界里，你只能有南北朝向或者东西朝向的墙。
每面墙的间隔必须是格子的整数倍，也就是说，
走廊要么是一格宽，要么是两格宽，但绝对不可能是 2.5 格宽。
尽管这种限制使得软件团队设计的关卡看起来都很相似，
但却令 Carmack 对*重返德军总部*渲染器的编写工作变得轻松了许多。

*重返德军总部*是用从屏幕向虚拟世界发射光线来解决 VSD 问题。
利用光线的渲染器一般叫做「光线投射渲染器」（raycasting render）。
这种渲染器通常都很慢，因为要通过光线投射来解决 VSD 问题需要找到光线和虚拟世界世界中的某个物体第一次相交的位置，
这通常会带来大量的计算。
但是对*重返德军总部*来说，因为所有的墙面都是轴对齐的，所以光线只能在网格线上和墙壁相交。
所以渲染器要做的事情就只是检查这些交点。
渲染器会从离玩家最近的交点开始检查，然后是次近的交点，以此类推，
最终当它遇到一面墙时就停止检查。
通过这种方式，只需要一点微不足道的代价就可以解决 VSD 问题，
因为这种算法就只是从每一个像素射出一条光线，令光线一直行进直到击中一面墙，
而光线的行进对 CPU 周期来说则非常廉价。
实际上，因为所有墙体的高度都是一样的，所以对每一列像素都只需要发射一条光线即可。









